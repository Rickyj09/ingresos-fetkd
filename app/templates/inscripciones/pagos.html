{% extends "base.html" %}
{% block title %}Pagos{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3>Pagos de Inscripción #{{ ins.id }}</h3>
    <div class="text-muted">
      Academia ID: {{ ins.academia_id }} | Evento ID: {{ ins.evento_id }} | Estado: {{ ins.estado }}
    </div>
  </div>
  <a class="btn btn-outline-dark" href="{{ url_for('inscripciones.index') }}">Volver</a>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="fw-bold">Total</div>
        <div class="fs-4">{{ "%.2f"|format(ins.total or 0) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="fw-bold">Pagado</div>
        <div class="fs-4">{{ "%.2f"|format(pagado or 0) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="fw-bold">Saldo</div>
        <div class="fs-4">{{ "%.2f"|format(ins.saldo or 0) }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="mb-3">Registrar Pago</h5>

    <form id="form-pago" method="post"
          action="{{ url_for('inscripciones.pagos_nuevo', inscripcion_id=ins.id) }}"
          class="row g-2">

      <div class="col-md-3">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-control" name="fecha_pago" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Valor</label>
        <!-- Nota: type="text" para evitar líos de coma/punto del navegador -->
        <input
          type="text"
          class="form-control"
          name="valor"
          required
          inputmode="decimal"
          placeholder="Ej: 70.00"
          pattern="^[0-9]+([.,][0-9]{1,2})?$"
          title="Ingresa un número, por ejemplo 70 o 70.00"
          autocomplete="off"
        >
        <div class="form-text">Acepta punto o coma (70.00 / 70,00).</div>
      </div>

      <div class="col-md-2">
        <label class="form-label">Método</label>
        <input class="form-control" name="metodo" placeholder="Efectivo/Transferencia">
      </div>

      <div class="col-md-2">
        <label class="form-label">Referencia</label>
        <input class="form-control" name="referencia">
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100">Guardar</button>
      </div>

      <div class="col-12">
        <label class="form-label">Observación</label>
        <input class="form-control" name="observacion">
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">Pagos registrados</h5>

    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Fecha</th>
          <th class="text-end">Valor</th>
          <th>Método</th>
          <th>Referencia</th>
          <th>Observación</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in pagos %}
        <tr>
          <td>{{ p.fecha_pago }}</td>
          <td class="text-end">{{ "%.2f"|format(p.valor or 0) }}</td>
          <td>{{ p.metodo or "" }}</td>
          <td>{{ p.referencia or "" }}</td>
          <td>{{ p.observacion or "" }}</td>
          <td class="text-end">
            <form method="post"
                  action="{{ url_for('inscripciones.pagos_eliminar', inscripcion_id=ins.id, pago_id=p.id) }}"
                  onsubmit="return confirm('¿Eliminar este pago?');"
                  style="display:inline;">
              <button class="btn btn-sm btn-outline-danger">Eliminar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if pagos|length == 0 %}
      <div class="text-muted">Aún no hay pagos.</div>
    {% endif %}
  </div>
</div>

<script>
  // Convierte coma a punto antes de enviar el form
  document.getElementById("form-pago")?.addEventListener("submit", function () {
    const input = this.querySelector('input[name="valor"]');
    if (input && input.value) {
      input.value = input.value.replace(/\s/g, "").replace("$", "").replace(",", ".");
    }
  });
</script>

{% endblock %}